name: Daily Stock Update

on:
  schedule:
    - cron: "0 3 * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      PYTHONUNBUFFERED: 1
      PYTHONIOENCODING: utf-8
      TERM: xterm-256color

    steps:
    - name: ğŸŸ¦ Checkout repository
      uses: actions/checkout@v4

    - name: ğŸŸ© Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: ğŸ“¦ Install dependencies
      run: |
        echo -e "\033[94mğŸ“¦ Installing Python dependencies...\033[0m"
        pip install pandas requests
        echo -e "\033[92mâœ” Dependencies installed\033[0m"

    - name: ğŸ“ Show repository files
      run: |
        echo -e "\033[95mğŸ“ Listing repo content...\033[0m"
        ls -R .
    
    - name: ğŸ”„ Update CACHE (cache.py)
      run: |
        echo -e "\033[96mğŸ”„ Running cache.py ...\033[0m"
        python cache.py
        echo -e "\033[92mâœ” cache.py completed\033[0m"

    - name: ğŸ§± Rebuild MASTER
      run: |
        echo -e "\033[96mğŸ§± Running generate_master.py ...\033[0m"
        python generate_master.py
        echo -e "\033[92mâœ” MASTER rebuilt\033[0m"

    - name: ğŸ’¾ Commit & Push updated files
      run: |
        echo -e "\033[93mğŸ’¾ Preparing commit...\033[0m"
        git config user.email "bot@github.com"
        git config user.name "Automation Bot"
        git add master_stocks.csv cache_av.json
        git commit -m "Daily auto update" || echo -e "\033[93mâš ï¸ Nothing to commit\033[0m"
        git push
        echo -e "\033[92mğŸš€ Update pushed to GitHub!\033[0m"
